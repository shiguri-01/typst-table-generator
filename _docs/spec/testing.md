# テスト戦略とセキュリティ

## テスト戦略

### 単体テスト

ユーティリティ関数のテストを `src/lib/` 配下に co-locate する。

**対象**:

- `parseTsv` — TSV パース処理
- `generateTypstCode` — Typst コード生成
- `createTableModel` — モデル正規化
- `validateTableModel` — モデルバリデーション
- エスケープ関数

**方針**:

- 入力 → 出力の期待値マッチング
- 境界値テスト（空文字列、巨大データ、不正値）
- エッジケース（セル内改行、特殊文字）

### コンポーネントテスト

React コンポーネントのテストは Testing Library を使用。

**対象**:

- `TableGridView` — セル編集、選択、キーボード操作
- `TableInspector` — プロパティ変更の反映
- `ExportPanel` — エクスポート処理

**方針**:

- ユーザーインタラクションのシミュレーション
- キーボード操作（Enter, Tab, Ctrl+B など）
- フォーカス移動とアクセシビリティ
- ストアとの統合（モック不要、実際のストアを使用）

### スナップショットテスト

Typst 出力の安定性を最小限で担保。

**対象**:

- 基本的なテーブルの Typst 出力
- プリセット適用後の出力
- ヘッダー、キャプション、罫線の組み合わせ

**方針**:

- スナップショットは最小限に抑える（5-10 パターン程度）
- 重要な仕様変更時のみ更新
- 手動での diff 確認を推奨

### E2E テスト（将来検討）

Playwright などを使った統合テスト。

**対象**:

- TSV 貼り付け → 編集 → Typst エクスポート の一連のフロー
- JSON インポート → 編集 → JSON エクスポート
- Undo/Redo の動作確認

## セキュリティ考慮事項

### XSS 対策

- セル内のテキストは Typst マークアップとして扱うため、HTML として解釈されない。
- プレビュー画面でもプレーンテキストまたはコードブロックとして表示。
- ユーザー入力を直接 DOM に挿入しない。

### データサイズ制限

- テーブルサイズの上限を設定（例: 1000 行 × 100 列）。
- 巨大な JSON の読み込み時は警告を表示。
- メモリ消費が懸念される場合はチャンク処理を検討。

### ローカルストレージ

- `localStorage` に保存するデータは JSON モデルのみ。
- 個人情報や機密情報は含まない想定。
- ストレージクォータ超過時のエラーハンドリング。

### クリップボード API

- `navigator.clipboard` の使用には HTTPS が必要。
- フォールバックとして `document.execCommand('copy')` を提供。
- 失敗時は手動コピー用のテキストエリアを表示。

## エラー処理

### バリデーション

- **空テーブル防止**: `rows.length >= 1` を UI 側でガード。
- **過大サイズ**: 行数・列数の上限チェック。
- **不正な値**: 数値フィールド（`width`, `strokeValue`）の範囲チェック。

### ユーザーフィードバック

- エラーメッセージは具体的で実行可能な内容にする。
  - 悪い例: "Invalid input"
  - 良い例: "列幅は 0 より大きい数値を指定してください"
- Intent UI の `Callout` や `Toast` でエラーを表示。
- 重大なエラーはモーダルで確認を求める。

### 例外の捕捉

- Typst 生成、JSON パース、TSV パースなど、失敗する可能性のある処理は try-catch でラップ。
- エラー境界（Error Boundary）でアプリ全体のクラッシュを防ぐ。
- 開発環境ではコンソールに詳細なスタックトレースを出力。

## パフォーマンス

### 目標

- ~100×30 までインタラクティブに編集可能。
- セル編集時のレンダリング遅延 < 100ms。
- Undo/Redo の応答時間 < 50ms。

### 最適化戦略

- **メモ化**: `useMemo` / `useCallback` で安定化。
- **仮想スクロール**: 大規模テーブルの場合は react-datasheet-grid の仮想スクロールを活用。
- **部分更新**: Zustand のセレクタで必要な部分のみ購読。
- **デバウンス**: `localStorage` への保存は 500ms デバウンス。

### 測定

- React DevTools Profiler で重いコンポーネントを特定。
- Chrome DevTools Performance でレンダリング時間を計測。
- 大規模データでの動作確認（100 行 × 30 列）。

## アクセシビリティ

### 要件

- キーボード操作のみでテーブル編集が完結すること。
- スクリーンリーダーで選択状態やセル内容が読み上げられること。
- フォーカス可視化が明確であること。

### 実装方針

- react-datasheet-grid の WAI-ARIA サポートを尊重。
- カスタム属性（`data-ttg-header` など）で追加情報を提供。
- `aria-label`, `aria-description` で補足説明。
- Intent UI コンポーネントのアクセシビリティ機能を活用。

### テスト

- axe DevTools でアクセシビリティ問題をチェック。
- スクリーンリーダー（NVDA, VoiceOver）で実際に操作確認。
- キーボードのみで全機能が使えることを確認。
